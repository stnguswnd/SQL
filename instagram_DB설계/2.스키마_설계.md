# 2. 스키마 설계 (Instagram + Chat)

## 1️⃣ 데이터베이스 생성

```sql
DROP DATABASE IF EXISTS instachat;
CREATE DATABASE instachat
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;
USE instachat;
```

**설명:**
- 이모지 지원을 위한 `utf8mb4`
- 인스타그램 + DM + 그룹채팅 통합 DB 설계용

---

## 2️⃣ 테이블 생성

### 2.1. Users (사용자)

```sql
CREATE TABLE users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone_number VARCHAR(20),
    password VARCHAR(255) NOT NULL,
    profile_image VARCHAR(255),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**특징**
- 사용자 계정 정보 관리
- 삭제 시 CASCADE로 관련 데이터 제거

---

### 2.2. Posts (게시물)

```sql
CREATE TABLE posts (
    post_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    content TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);
```

**특징**
- 사용자와 1:N 관계
- 게시물 삭제 시 댓글, 미디어, 좋아요도 함께 삭제

---

### 2.3. Media (미디어)

```sql
CREATE TABLE media (
    media_id INT PRIMARY KEY AUTO_INCREMENT,
    post_id INT NOT NULL,
    media_url VARCHAR(255) NOT NULL,
    media_type ENUM('image', 'video') NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(post_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);
```

---

### 2.4. Comments (댓글)

```sql
CREATE TABLE comments (
    comment_id INT PRIMARY KEY AUTO_INCREMENT,
    post_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(post_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);
```

---

### 2.5. SubComments (대댓글)

```sql
CREATE TABLE subcomments (
    subcomment_id INT PRIMARY KEY AUTO_INCREMENT,
    comment_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (comment_id) REFERENCES comments(comment_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);
```

---

### 2.6. Likes (좋아요)

```sql
CREATE TABLE likes (
    like_id INT PRIMARY KEY AUTO_INCREMENT,
    post_id INT NOT NULL,
    user_id INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(post_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT unique_like UNIQUE (post_id, user_id)
);
```

---

### 2.7. Follows (팔로우)

```sql
CREATE TABLE follows (
    follow_id INT PRIMARY KEY AUTO_INCREMENT,
    sender_id INT NOT NULL,
    receiver_id INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sender_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (receiver_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT unique_follow UNIQUE (sender_id, receiver_id)
);
```

---

### 2.8. ChatRooms (채팅방)

```sql
CREATE TABLE chatrooms (
    chatroom_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    is_group BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

### 2.9. ChatParticipants (채팅방 참가자)

```sql
CREATE TABLE chat_participants (
    id INT PRIMARY KEY AUTO_INCREMENT,
    chatroom_id INT NOT NULL,
    user_id INT NOT NULL,
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (chatroom_id) REFERENCES chatrooms(chatroom_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT unique_participant UNIQUE (chatroom_id, user_id)
);
```

---

### 2.10. Messages (메시지)

```sql
CREATE TABLE messages (
    message_id INT PRIMARY KEY AUTO_INCREMENT,
    chatroom_id INT NOT NULL,
    sender_id INT NOT NULL,
    content TEXT NOT NULL,
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (chatroom_id) REFERENCES chatrooms(chatroom_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(user_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);
```

---

## 3️⃣ 샘플 데이터 삽입

```sql
INSERT INTO users (name, email, password, profile_image)
VALUES
('Alice', 'alice@mail.com', 'hash1', '/img/a.jpg'),
('Bob', 'bob@mail.com', 'hash2', '/img/b.jpg'),
('Charlie', 'charlie@mail.com', 'hash3', '/img/c.jpg');
```

```sql
INSERT INTO chatrooms (name, is_group) VALUES
('Alice-Bob 1:1', FALSE),
('Study Group', TRUE);

INSERT INTO chat_participants (chatroom_id, user_id) VALUES
(1, 1), (1, 2),
(2, 1), (2, 2), (2, 3);
```

```sql
INSERT INTO messages (chatroom_id, sender_id, content) VALUES
(1, 1, '안녕 Bob!'),
(1, 2, '안녕 Alice!'),
(2, 3, '내일 스터디 할래요?'),
(2, 1, '좋아요!');
```

---

## 4️⃣ 제약조건 테스트

```sql
-- 중복 팔로우 불가
INSERT INTO follows (sender_id, receiver_id) VALUES (1, 2);
INSERT INTO follows (sender_id, receiver_id) VALUES (1, 2);  -- ❌ 실패

-- 채팅방 중복 참여 불가
INSERT INTO chat_participants (chatroom_id, user_id) VALUES (1, 1);  -- ❌ 실패
```

---

## ✅ 5️⃣ 핵심 설계 요약

| 기능 | 테이블 | 관계 | 설명 |
|------|---------|------|------|
| 사용자 관리 | users | - | 기본 유저 정보 |
| 피드 | posts, media, likes | users 1:N | 게시글, 미디어, 좋아요 |
| 댓글 | comments, subcomments | posts 1:N | 댓글, 대댓글 |
| 팔로우 | follows | users self 1:N | 팔로잉 관계 |
| 채팅 | chatrooms, chat_participants, messages | users ↔ chatrooms N:M | 1:1 및 그룹채팅 지원 |
